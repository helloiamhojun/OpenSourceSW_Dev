## Kafka 자료 조사 보완

## 실제 산업 동향과 기술 적용 사례 (문제-해결 위주)

** 문제는 (?), 해결은 (!)로 표시해 작성하겠음.

---

### 클라우드 환경에서의 적용 사례  

영상 링크: https://youtu.be/XyuqoWUCdGA?si=ml4h7OmQ-2CLR5DS  

---

 ### 문제 1) 단일 주키퍼 의존 문제
    
  카프카 도입 초기에는 하나의 주키퍼 클러스터에 여러 카프카 클러스터를 구성 (이때 카프카 클러스터는 (MSA 기반으로 개별적으로 분리되어 있는) 각 서비스별로 구성)
  
  ->  이로 인해 초기엔 괜찮았지만, 클러스터가 많아질수록 단일 주키퍼에 대한 의존도가 높아져 단일 장애 지점이 됨. (?)
  
  (!) : 격리된 클러스터 구성으로 변경. (주키퍼:카프카 = 1:1 구조) -> 서비스 별로 격리된 환경을 조성해 문제 발생 시 영향을 최소화시킴.

### 문제 2) 업데이트 방식(기존: 롤링 업데이트)의 한계
    
  카프카는 다양한 상황에서 업데이트가 필요 -> 그런데 관리할 브로커가 많아지면, 업데이트에 시간이 오래 걸림 (?)
  
  (!) : 쉬운 업데이트 환경으로 변경. (카프카 클러스터 내에 논리적인 스택을 구성해 이를 기준으로 브로커를 추가/제거하는 방식으로 업데이트를 진행.
  
  ### 문제 3) 카프카 스트림즈의 상태 깨짐 문제 (브로커 장애 시 서비스 장애로 연결)

  대표적인 원인: 클라우드에서의 네트워크 이슈  
  
  (실제 사례) 네트워크 통신이 불안정해 해당 브로커의 세션이 만료되어 클러스터에서 제외됨 -> 배달의 민족 서비스에서 라이더 수가 음수로 집계된 장애 사례가 있었음. (서비스 장애... (?))  
  
  (!) : kafka-streams-application-reset.sh 스크립트를 이용한 복구 (상당한 공수가 필요..) -> 불완전한 해결책. 개선 필요
  
  ** kafka-streams-application-reset.sh 스크립트란 스트림즈를 초기 상태로 되돌리는 공식 유틸리티 스크립트. 이를 이용하면 장애가 발생했을 때 내부 토픽과, 어디까지 읽었는지 기록한 offset, state store을 자동으로 삭제해줌 -> 상태 복구를 위한 도구.)

---

 ### cf. MSA  
 
 kafka를 이야기할 때는 MSA의 개념을 반드시 알아야 함 -> 이와 관련해 교수님께서 예전에 수업 시간에 보여주신 영상: https://youtu.be/BnS6343GTkY?si=_48lMS3fP9UcsdHC

---

## 유사 기술 비교 (추가내용)  

Kafka, RabbitMQ  

공통점: 둘 다 병렬 처리를 지원  
  
차이점: 병렬 처리의 방식과 목적이 다름 
- Kafka: 파티션 기반 병렬처리. 메시지를 Topic->Partition 단위로 쪼개고, 각 Partition은 1개의 컨슈머에 의해서만 읽을 수 있음. 즉, 파티션 수 만큼 병렬 처리 가능. 대량의 데이터 스트림을 빠르게 처리하기 위해 병렬 처리를 사용.
- RabitMQ: 메세지를 큐에 넣고 그 큐를 여러 컨슈머가 처리할 수 있게 해 병렬 처리 효과를 냄.(즉, 큐에 연결된 소비자 수만큼 병렬성 확보) 단, 이때 하나의 메세지는 하나의 컨슈머만 처리 가능. 이때 전달 순서가 유지 가능한 이유는 큐 안에서 메세지가 FIFO로 저장되어 있기 때문. 단, 각 컨슈머의 처리 속도 차이 때문에 완료 순서는 달라질 수 있음. 병렬 처리의 목적은 작업 처리 속도 향상을 위함임
